window.Cropbox=function(a,b){"use strict";function c(a,b){b="object"==typeof a?a:Object.assign(b||{},{cb:a}),this._configurate(b),this._initEvents()}var d={scale:function(a){this._disabledControls||this._refreshRatio(this._ratio*a)},load:function(a){this._sourceImage.src=a},reset:function(){this._clearData(),this._resetVariant(),this._hideWorkarea(),this._disableControls(),this._trigger("cb.reset")},crop:function(){if(!this._disabledControls){var a=this._frame.offsetLeft-this._image.offsetLeft,c=this._frame.offsetTop-this._image.offsetTop,d=this._frame.clientWidth,e=this._frame.clientHeight,f=b.createElement("canvas");f.width=d,f.height=e,f.getContext("2d").drawImage(this._image,0,0,this._sourceImage.width,this._sourceImage.height,-a,-c,this._image.clientWidth,this._image.clientHeight);var g={sWidth:this._sourceImage.width,sHeight:this._sourceImage.height,x:a,y:c,dWidth:this._image.clientWidth,dHeight:this._image.clientHeight,ratio:this._ratio,width:d,height:e,image:f.toDataURL("image/png")};this._trigger("cb.cropped",{data:g})}},getData:function(){return this._data},getCb:function(){return this._cb},getMembrane:function(){return this._membrane},getImage:function(){return this._image},getFrame:function(){return this._frame},getWorkarea:function(){return this._workarea},getResize:function(){return this._resize},getVersion:function(){return"0.9.0"}},e={_configurate:function(a){this.dO={variants:[{width:200,height:200,minWidth:200,minHeight:200,maxWidth:350,maxHeight:350}]},this._cb=null,this._data=[],this._frame=null,this._image=null,this._workarea=null,this._membrane=null,this._resize=null,this._frameState={},this._imageState={},this._resizeState={},this._sourceImage=b.createElement("img"),this._ratio=1,this._variants=[],this._indexVariant=0,this._disabledControls=!1,this._cb="string"==typeof a.cb?b.querySelector(a.cb):a.cb,this._variants=a.variants||this.dO.variants,this._image=this._cb.querySelector(".image-cropbox"),this._frame=this._cb.querySelector(".frame-cropbox"),this._workarea=this._cb.querySelector(".workarea-cropbox"),this._membrane=this._cb.querySelector(".membrane-cropbox"),this._resize=this._cb.querySelector(".resize-cropbox")},_initEvents:function(){this._attachFrameMouseDownEvent(),this._attachFrameMouseMoveEvent(),this._attachFrameMouseUpEvent(),this._attachResizeMouseDownEvent(),this._attachResizeMouseMoveEvent(),this._attachResizeMouseUpEvent(),this._attachImageMouseDownEvent(),this._attachImageMouseMoveEvent(),this._attachImageMouseUpEvent(),this._attachResizeWorkareaEvent(),this._attachLoadEvent(),this._attachCroppedEvent()},_initFrame:function(){var a=this._getCurrentVariant(),b=this._workarea.clientWidth/2-a.width/2,c=this._workarea.clientHeight/2-a.height/2;this._frame.style.width=a.width+"px",this._frame.style.height=a.height+"px",this._frame.style.backgroundImage='url("'+this._sourceImage.src+'")',this._refrashPosFrame(b,c)},_initImage:function(){var a=this._image.clientWidth/2-this._workarea.clientWidth/2,b=this._image.clientHeight/2-this._workarea.clientHeight/2;this._refrashPosImage(-a,-b)},_initRatio:function(){var a=this._getCurrentVariant(),b=a.width/this._sourceImage.width,c=a.height/this._sourceImage.height;b>c?this._refreshRatio(b):this._refreshRatio(c)},_refrashPosFrame:function(a,b){var c=this._image.offsetLeft,d=this._image.offsetTop,e=c-a,f=d-b;e>0?(e=0,a=c):this._image.clientWidth+c<a+this._frame.clientWidth&&(e=this._frame.clientWidth-this._image.clientWidth,a=c+this._image.clientWidth-this._frame.clientWidth),f>0?(f=0,b=d):this._image.clientHeight+d<b+this._frame.clientHeight&&(f=this._frame.clientHeight-this._image.clientHeight,b=d+this._image.clientHeight-this._frame.clientHeight),this._frame.style.left=a+"px",this._frame.style.top=b+"px",this._frame.style.backgroundPosition=e+"px "+f+"px"},_refrashSizeFrame:function(a,b){var c=this._image.offsetLeft,d=this._image.offsetTop,e=this._frame.offsetLeft,f=this._frame.offsetTop,g=this._frame.clientWidth,h=this._frame.clientHeight,i=this._getCurrentVariant(),j=i.maxWidth,k=i.maxHeight,l=i.minWidth,m=i.minHeight;a>g&&void 0===j?j=g:a<g&&void 0===l&&(l=g),b>h&&void 0===k?k=h:b<h&&void 0===m&&(m=h),a>j?a=j:a<l&&(a=l),this._image.clientWidth+c<e+a&&(a=this._image.clientWidth+c-e),b>k?b=k:b<m&&(b=m),this._image.clientHeight+d<f+b&&(b=this._image.clientHeight+d-f),this._frame.style.width=a+"px",this._frame.style.height=b+"px"},_refrashPosImage:function(a,b){this._image.style.left=a+"px",this._image.style.top=b+"px"},_refreshRatio:function(a){var b=this._ratio;this._ratio=a;var c=this._sourceImage.width*this._ratio,d=this._sourceImage.height*this._ratio;c>=this._frame.clientWidth&&d>=this._frame.clientHeight?(this._image.style.width=c+"px",this._image.style.height=d+"px",this._frame.style.backgroundSize=c+"px "+d+"px",this._refrashPosFrame(this._frame.offsetLeft,this._frame.offsetTop)):this._ratio=b},_showWorkarea:function(){this._workarea.style.display="block"},_hideWorkarea:function(){this._workarea.style.display="none"},_resetVariant:function(){this._indexVariant=0},_getCurrentVariant:function(){return this._variants[this._indexVariant]},_nextVariant:function(){this._variants.length<=this._indexVariant+1&&(this._indexVariant=0,this._stop()),++this._indexVariant,this._initRatio(),this._initImage(),this._initFrame()},_clearData:function(){this._data=[]},_addData:function(a){this._data.push(a)},_start:function(){this._enableControls(),this._clearData(),this._resetVariant(),this._showWorkarea(),this._initRatio(),this._initImage(),this._initFrame()},_stop:function(){this._disableControls(),this._hideWorkarea()},_disableControls:function(){this._disabledControls=!0,this._trigger("cb.disabledCtrls")},_enableControls:function(){this._disabledControls=!1,this._trigger("cb.enabledCtrls")},_trigger:function(c,d){var e=null;a.CustomEvent?e=new CustomEvent(c,{detail:d}):(e=b.createEvent("CustomEvent"),e.initCustomEvent(c,!0,!0,d)),this._cb.dispatchEvent(e)}},f={_attachLoadEvent:function(){var a=this;this._sourceImage.addEventListener("load",function(){a._image.addEventListener("load",function(){a._start()}),a._image.src=this.src,a._trigger("cb.loaded")})},_attachFrameMouseDownEvent:function(){var a=this;this._frame.addEventListener("mousedown",function(b){a._frameState.dragable=!0,a._frameState.mouseX=b.clientX,a._frameState.mouseY=b.clientY})},_attachFrameMouseMoveEvent:function(){var a=this;this._frame.addEventListener("mousemove",function(b){if(a._frameState.dragable){var c=a._frame.offsetLeft,d=a._frame.offsetTop,e=b.clientX-a._frameState.mouseX+c,f=b.clientY-a._frameState.mouseY+d;a._frameState.mouseX=b.clientX,a._frameState.mouseY=b.clientY,a._refrashPosFrame(e,f)}})},_attachFrameMouseUpEvent:function(){var a=this;b.addEventListener("mouseup",function(b){b.preventDefault(),b.stopPropagation(),a._frameState.dragable=!1})},_attachResizeMouseDownEvent:function(){var a=this;this._resize.addEventListener("mousedown",function(b){b.stopImmediatePropagation(),a._resizeState.dragable=!0,a._resizeState.mouseX=b.clientX,a._resizeState.mouseY=b.clientY})},_attachResizeMouseMoveEvent:function(){var a=this;b.addEventListener("mousemove",function(b){if(a._resizeState.dragable){var c=a._frame.clientWidth,d=a._frame.clientHeight,e=b.clientX-a._resizeState.mouseX+c,f=b.clientY-a._resizeState.mouseY+d;a._resizeState.mouseX=b.clientX,a._resizeState.mouseY=b.clientY,a._refrashSizeFrame(e,f)}})},_attachResizeMouseUpEvent:function(){var a=this;b.addEventListener("mouseup",function(b){b.preventDefault(),b.stopPropagation(),a._resizeState.dragable=!1})},_attachImageMouseDownEvent:function(){var a=this;this._membrane.addEventListener("mousedown",function(b){a._imageState.dragable=!0,a._imageState.mouseX=b.clientX,a._imageState.mouseY=b.clientY})},_attachImageMouseMoveEvent:function(){var a=this;this._membrane.addEventListener("mousemove",function(b){if(a._imageState.dragable){var c=getComputedStyle(a._image).left,d=getComputedStyle(a._image).top,e=b.clientX-a._imageState.mouseX+parseFloat(c),f=b.clientY-a._imageState.mouseY+parseFloat(d);a._imageState.mouseX=b.clientX,a._imageState.mouseY=b.clientY,a._refrashPosImage(e,f),a._frameState.mouseX=b.clientX,a._frameState.mouseY=b.clientY,a._refrashPosFrame(parseFloat(getComputedStyle(a._frame).left),parseFloat(getComputedStyle(a._frame).top))}})},_attachImageMouseUpEvent:function(){var a=this;this._membrane.addEventListener("mouseup",function(b){b.preventDefault(),b.stopPropagation(),a._imageState.dragable=!1})},_attachResizeWorkareaEvent:function(){var b=this;a.addEventListener("resize",function(){b._initRatio(),b._initImage(),b._initFrame()})},_attachCroppedEvent:function(){var a=this;this._cb.addEventListener("cb.cropped",function(b){a._addData(b.detail.data),a._nextVariant()})}};return c.prototype=Object.assign(c.prototype,d,e,f),c}(window,document);